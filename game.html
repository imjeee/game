<!DOCTYPE html>
<html>
<head>
  <style>
  </style>
</head>
<body>
<script>

  const cc = console.log

  const ground = 722
  const heroWidth = 150
  const heroHeight = 200
  let reqFrameCount = 1;

  const loadImage = url => {
    return new Promise((resolve, reject) => {
      const img = new Image()
      img.onload = () => resolve(img)
      img.onerror = () => reject()
      img.src = url
    })
  }

  // create background canvas
  const bgCanvas = document.createElement('canvas')
  const bgCtx = bgCanvas.getContext('2d')
  bgCanvas.width = 1920
  bgCanvas.height = 1200
  bgCanvas.style.position = 'absolute'
  bgCanvas.style.top = 0
  bgCanvas.style.left = 0
  document.body.appendChild(bgCanvas)

  // create foreground canvas
  const fgCanvas = document.createElement('canvas')
  const fgCtx = fgCanvas.getContext('2d')
  fgCanvas.width = 1920
  fgCanvas.height = 1200
  fgCanvas.style.position = 'absolute'
  fgCanvas.style.top = 0
  fgCanvas.style.left = 0
  document.body.appendChild(fgCanvas)

  // background image
  let backgroundImage;
  loadImage('img/background.png')
  .then(bgImg => {
    backgroundImage = bgImg
    // bgCtx.drawImage(backgroundImage, 0, 0)
  })

  let heroImage;
  loadImage('img/hero.png')
  .then(hrImg => {
    heroImage = hrImg;
  })

  // game objects
  let hero = {
    topSpeed: 15, // movement in pixels per second
    jumpSpeed: 12,

    x: 0,
    vx: 2,
    ax: 1,

    y: 722,
    vy: .5,
    ay: 0

  }

  // handle keyboard controls
  const keysDown = {}
  let jumped = false
  let goingup = false

  window.addEventListener('keydown', (e) => {
    if (e.keyCode === 38) {
      // console.log('jump')
      // console.log(jumped)
    }
    if (e.keyCode === 38 && !jumped) {
      console.log('jmp')
      jumped = true
      goingup = true
      hero.ay = hero.jumpSpeed
      reqFrameCount++;
      requestAnimationFrame(main)
    } else {
      keysDown[e.keyCode] = true
    }

  }, false)

  window.addEventListener('keyup', (e) => {
    delete keysDown[e.keyCode]
  }, false)

  //update game object
  const update = (modifier) => {

    if (jumped) {
      if (goingup) {
        if (hero.ay < 1) {
          goingup = false
          hero.ay = -1
        }
        hero.ay /= 1.4
      } else {
        hero.ay *= 1.2

        if (hero.y >= ground) {
          jumped = false
          hero.ay = 0
          hero.vy = 0
          hero.y = ground
        }
      }

      hero.vy += hero.ay
      hero.y -= hero.vy
      hero.y = Math.min(ground, hero.y)
    }

    // if (40 in keysDown) {}

    if (37 in keysDown) { // Player holding left
      if (Math.abs(hero.vx) < hero.topSpeed) {
        hero.vx -= hero.ax
      }
    }

    if (39 in keysDown) { // Player holding right
      if (Math.abs(hero.vx) < hero.topSpeed) {
        hero.vx += hero.ax
      }
    }

    if (Object.keys(keysDown).length === 0) {
      hero.vx /= 1.2;
      if (Math.abs(hero.vx) < 1) {
        hero.vx = 0
      }
    }

    hero.x += hero.vx
    hero.x = Math.max(hero.x, 0)
    hero.x = Math.min(hero.x, fgCanvas.width - heroWidth)
  }

  const render = () => {
    if (backgroundImage) {
      bgCtx.drawImage(backgroundImage, 0, 0)
    }

    if (heroImage) {
      // fgCtx.clearRect(hero.x - 50, hero.y - 50, heroWidth + 500, heroHeight + 500)
      fgCtx.clearRect(0,0, fgCanvas.width, fgCanvas.height)
      fgCtx.drawImage(heroImage, hero.x, hero.y, heroWidth, heroHeight)
    }
  }

  let main = () => {
    // console.log(hero.x)
    update(10)
    render(10)
    if (reqFrameCount <= 1) {
      requestAnimationFrame(main)
    } else {
      reqFrameCount--;
    }
  }

  main()

</script>
</body>
</html>